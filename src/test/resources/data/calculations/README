CALCULATIONS:

PAYE:

Variables calculated: 

1. paye_employees: a sum of paye employees averages of all Legal Units of the Enterprise
2. paye_jobs: a sum of last quarters across all Legal Units of the Enterprise

paye_job calcuation:
1. Calculate an average for each paye_ref: sum of all quarters divided by a number of quarters with non-null values
2. Sum averages calculated at step 1 above

VAT:

Record types:
0 - Standard
1 - Representative
2 - Divisional
3 - Non-Representative


 Variables calculated:

 1. contained_group_turnover: 
     1.1 Identify vat group members by selecting records with same first 9 digits
     1.2 Each vat group has 1 representative turnover and 1 + non-representative turnovers
     1.3 Ensure relevance of contained_group_turnover by confirming all given vat group lays within one enterprise. If this is the case, continue
     1.4 Return the value of representative turnover

 2. apportioned_turnover:
     1.1 Ensure given group includes multiple enterprises
     1.2 Extract representative turnover of the given group
     1.3 Calculate weights of turnovers across multiple Enterprises belonging to this vat group:
         1.2.1 Calculate total group payee_employee by summing paye_employees of all Enterprises of the group
         1.2.2 Calculate apportioned turnover for each ENT-n of the group: (group_rep_turnover / total group payee_employee) * ENT-n.paye_employees

 3. ent_turnover:
    contained_turnover + apportioned_turnover + standard_turnover

So, having inputs:

BI data [Fragment with relevant data]
+--------------------+--------------+-------------------------------+----------+------------+
|        BusinessName|      PayeRefs|             VatRefs           |       ern|          id|
+--------------------+--------------+-------------------------------+----------+------------+
|      INDUSTRIES LTD|       [1151L]|      [123123123000]           |2000000011|100002826247|
|BLACKWELLGROUP LT...|[1152L, 1153L]|      [111222333000]           |1100000003|100000246017|
|BLACKWELLGROUP LT...|[1154L, 1155L]|      [111222333001]           |1100000003|100000827984|
|             IBM LTD|[1166L, 1177L]|[555666777000, 5556667770001]  |1100000004|100000459235|
|         IBM LTD - 2|[1188L, 1199L]|      [555666777002]           |1100000004|100000508723|
|         IBM LTD - 3|[5555L, 3333L]|      [999888777000]           |1100000004|100000508724|
|             MBI LTD|       [9876L]|      [555666777003]           |2200000002|100000601835|
|   NEW ENTERPRISE LU|       [1999Z]|      [919100010000]           |9900000009|999000508999|
+--------------------+--------------+-------------------------------+----------+------------+

VAT Refs:
+--------------+----------+-------------+
|    vatref    | turnover | record_type |
+--------------+----------+-------------+
| 555666777003 |   260    |     3       |
| 919100010000 |    85    |     2       |
| 999888777000 |   260    |     0       |
| 555666777002 |   340    |     3       |
| 555666777000 |  1000    |     1       |
| 555666777001 |   320    |     3       |
| 111222333001 |   590    |     3       |
| 111222333000 |   585    |     1       |
| 123123123000 |   390    |     0       |
+--------------+----------+-------------+

Paye refs:
+-------+--------+---------+---------+--------+
|payeref|mar_jobs|june_jobs|sept_jobs|dec_jobs|
+-------+--------+---------+---------+--------+
|  1151L|       1|        2|        3|       4|
|  1152L|       5|        6|     null|       8|
|  1153L|       9|        1|        2|       3|
|  1154L|       4|     null|        6|       7|
|  1155L|       8|        9|        1|       2|
|  1166L|       1|        1|        2|       3|
|  3333L|       1|        1|        2|       3|
|  1188L|       2|        2|        2|       2|
|  1199L|    null|     null|     null|    null|
|  5555L|    null|     null|     null|    null|
|  1999Z|       1|        3|        4|       5|
|  9876L|       6|        5|        4|       5|
+-------+--------+---------+---------+--------+


Data un-aggregated view:
+---------+----------+------------+--------+-----------+-----------+---------+----------------+----------------+------------+-------------+------------+------------+
|vat_group|       ern|      vatref|turnover|record_type|paye_empees|paye_jobs|group_empl_total|no_ents_in_group|grp_turnover|cntd_turnover|std_turnover|app_turnover|
+---------+----------+------------+--------+-----------+-----------+---------+----------------+----------------+------------+-------------+------------+------------+
|   999888|1100000004|999888777000|     260|          0|          4|        8|               4|               1|        null|         null|         260|        null|
|   555666|1100000004|555666777000|    1000|          1|          4|        8|               9|               2|        1000|         null|        null|         444|
|   555666|1100000004|555666777001|     320|          3|          4|        8|               9|               2|        1000|         null|        null|         444|
|   555666|1100000004|555666777002|     340|          3|          4|        8|               9|               2|        1000|         null|        null|         444|
|   555666|2200000002|555666777003|     260|          3|          5|        5|               9|               2|        1000|         null|        null|         555|
|   919100|9900000009|919100010000|      85|          1|          3|        5|               3|               1|        null|           85|        null|        null|
|   111222|1100000003|111222333000|     585|          1|         19|       20|              19|               1|        null|          585|        null|        null|
|   111222|1100000003|111222333001|     590|          3|         19|       20|              19|               1|        null|         null|        null|        null|
|   123123|2000000011|123123123000|     390|          0|          2|        4|               2|               1|        null|         null|         390|        null|
+---------+----------+------------+--------+-----------+-----------+---------+----------------+----------------+------------+-------------+------------+------------+

results:
+------------------+-----------+---------+-------------+------------+------------+------------+------------+
|               ern|paye_empees|paye_jobs|cntd_turnover|app_turnover|std_turnover|grp_turnover|ent_turnover|
+------------------+-----------+---------+-------------+------------+------------+------------+------------+
|        4000000011|          4|        8|         null|         444|         260|        1000|         704|
|        5000000011|          5|        5|         null|         555|        null|        1000|         555|
|        2000000011|          2|        4|         null|        null|         390|        null|         390|
|        3000000011|         19|       20|          585|        null|        null|        null|         585|
|111111111-TEST-ERN|          3|        5|           85|        null|        null|        null|          85|
+------------------+-----------+---------+-------------+------------+------------+------------+------------+

Calculation example:
VAT Group 555666 contains 2 enterprises: 1100000004 and 2200000002

2200000002:    belongs to 1 group, which does not include any other enterprises
               non-representative turnover: 260
               5 paye_empees

1100000004:    spread over 2 VAT groups: 555666(this one) and 999888 (this one includes another enterprise) and:
               has  2 non-representative turnovers:  320 and 340,
               one representative: 1000,
               one standard turnover from within another group(999888): 260
               4 paye_empees

Calculations

2200000002:  grp_turnover = 1000
             app_turnover =  555
                            sum of representative turnovers = 1000
                            total group empees(group_empl_total) = 9
                            paye_empees = 5
                            1000 / 9 * 5 = 555.(5), rounded to int = 555
             ent_turnover = 555
             all other turnovers are null

1100000004:  std_turnover = 260
             app_turnover = 444
                       sum of representative turnovers = 1000
                       total group empees(group_empl_total) = 9
                       paye_empees = 4
                       1000 / 9 * 4 = 444.(4), rounded to int = 444
             grp_turnover = 1000
             ent_turnover = 260 + 444 = 704
             contd_turnover = null
